name: Sync Packages from FigureYa
 
on:
  workflow_dispatch:
    inputs:
      force_update:
        description: 'Force update all packages'
        required: false
        default: 'false'
        type: boolean
  schedule:
    # æ¯å‘¨æ—¥è¿è¡Œä¸€æ¬¡
    - cron: '0 2 * * 0'
 
jobs:
  sync-packages:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout FigureYa-package repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.FIGUREYA2ACTION }}
    
    - name: Setup R (latest version)
      uses: r-lib/actions/setup-r@v2
      with:
        r-version: 'release'  # ä½¿ç”¨æœ€æ–°ç¨³å®šç‰ˆæœ¬
        use-public-rspm: true
    
    - name: Install R dependencies
      run: |
        install.packages(c("rvest", "stringr", "jsonlite", "httr"), 
                        repos = "https://cloud.r-project.org/")
      shell: Rscript {0}
    
    - name: Extract package versions from FigureYa
      run: |
        Rscript scripts/extract_versions_from_figureya.R
      env:
        GITHUB_TOKEN: ${{ secrets.FIGUREYA2ACTION }}
    
    - name: Download packages with size check
      run: |
        Rscript scripts/download_packages_with_size_check.R
    
    - name: Check file sizes and storage usage
      run: |
        echo "=== File Size Check ==="
        # æ£€æŸ¥æ˜¯å¦æœ‰è¶…è¿‡100MBçš„æ–‡ä»¶
        large_files=$(find packages/ -type f -size +100M 2>/dev/null || true)
        if [ -n "$large_files" ]; then
          echo "âŒ Found files larger than 100MB (GitHub limit):"
          echo "$large_files"
          find packages/ -type f -size +100M -exec ls -lh {} \; 2>/dev/null || true
          echo "These files will be moved to releases or external storage"
        else
          echo "âœ… All files are under 100MB limit"
        fi
        
        echo ""
        echo "=== Storage Summary ==="
        if [ -d "packages" ]; then
          echo "Package directory size:"
          du -sh packages/
          
          echo "Breakdown by R version:"
          du -sh packages/*/* 2>/dev/null || echo "No version subdirectories"
          
          echo "File count by type:"
          find packages/ -name "*.tar.gz" | wc -l | xargs echo "tar.gz files:"
          
          # è®¡ç®—æ€»å¤§å°ï¼ˆMBï¼‰
          total_size_mb=$(du -sm packages/ | cut -f1)
          echo "Total size: ${total_size_mb}MB"
          
          # GitHubä»“åº“å»ºè®®é™åˆ¶åœ¨1GBä»¥ä¸‹
          if [ "$total_size_mb" -gt 1000 ]; then
            echo "âš ï¸  Warning: Repository size (${total_size_mb}MB) is getting large"
            echo "Consider implementing cleanup strategy"
          fi
        else
          echo "No packages directory found"
        fi
    
    - name: Handle large files
      run: |
        # å°†å¤§äº100MBçš„æ–‡ä»¶ç§»åŠ¨åˆ°å•ç‹¬çš„ç›®å½•ï¼Œå‡†å¤‡ä¸Šä¼ åˆ°releases
        if [ -d "packages" ]; then
          mkdir -p large_files_for_release
          
          find packages/ -type f -size +100M -exec mv {} large_files_for_release/ \; 2>/dev/null || true
          
          if [ -n "$(ls -A large_files_for_release 2>/dev/null)" ]; then
            echo "Moved large files to large_files_for_release/"
            ls -lh large_files_for_release/
            
            # åˆ›å»ºå¤§æ–‡ä»¶æ¸…å•
            echo "# Large Files (>100MB)" > large_files_manifest.md
            echo "These files are too large for direct git storage and should be uploaded to releases:" >> large_files_manifest.md
            echo "" >> large_files_manifest.md
            ls -lh large_files_for_release/ >> large_files_manifest.md
          fi
        fi
    
    - name: Safe commit and push with conflict resolution
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "FigureYa Package Sync"
        
        # è®¾ç½®åˆå¹¶ç­–ç•¥
        git config pull.rebase true
        git config rebase.autoStash true
        
        # æ·»åŠ .gitignoreæ¥å¿½ç•¥å¤§æ–‡ä»¶ç›®å½•
        echo "large_files_for_release/" >> .gitignore
        echo "*.tar.gz.large" >> .gitignore
        
        # æš‚å­˜æ›´æ”¹
        git add metadata/ || echo "No metadata to add"
        git add packages/ || echo "No packages to add"
        git add .gitignore || echo "No gitignore changes"
        git add large_files_manifest.md || echo "No large files manifest"
        
        if git diff --staged --quiet; then
          echo "No changes to commit"
          exit 0
        fi
        
        # è·å–å½“å‰åˆ†æ”¯
        current_branch=$(git branch --show-current)
        echo "Current branch: $current_branch"
        
        # å°è¯•å¤šç§pullç­–ç•¥
        echo "ğŸ“¥ Pulling latest changes..."
        pull_success=false
        
        # ç­–ç•¥1: æ­£å¸¸pull with rebase
        if git pull --rebase origin $current_branch 2>/dev/null; then
          echo "âœ… Normal pull successful"
          pull_success=true
        else
          echo "âš ï¸  Normal pull failed, trying alternative methods..."
          
          # ç­–ç•¥2: fetch + rebase
          if git fetch origin && git rebase origin/$current_branch 2>/dev/null; then
            echo "âœ… Fetch + rebase successful"
            pull_success=true
          else
            echo "âš ï¸  Rebase failed, trying merge strategy..."
            git rebase --abort 2>/dev/null || true
            
            # ç­–ç•¥3: fetch + merge
            if git fetch origin && git merge origin/$current_branch --no-edit 2>/dev/null; then
              echo "âœ… Fetch + merge successful"
              pull_success=true
            else
              echo "âš ï¸  Merge also failed, checking for conflicts..."
              
              # ç­–ç•¥4: é‡ç½®å¹¶é‡æ–°åº”ç”¨æ›´æ”¹
              echo "ğŸ”„ Resetting and reapplying changes..."
              git reset --soft HEAD~1 2>/dev/null || true
              git fetch origin
              git reset --hard origin/$current_branch
              
              # é‡æ–°æ·»åŠ æˆ‘ä»¬çš„æ›´æ”¹
              git add metadata/ packages/ .gitignore large_files_manifest.md 2>/dev/null || true
              pull_success=true
            fi
          fi
        fi
        
        if [ "$pull_success" = false ]; then
          echo "âŒ All pull strategies failed, proceeding with caution..."
        fi
        
        # æ£€æŸ¥å¹¶è§£å†³å†²çª
        if git status --porcelain | grep -q "^UU\|^AA\|^DD\|^DU\|^UD"; then
          echo "ğŸ”§ Resolving merge conflicts..."
          
          # å¯¹äºæˆ‘ä»¬å…³å¿ƒçš„æ–‡ä»¶ï¼Œä½¿ç”¨æˆ‘ä»¬çš„ç‰ˆæœ¬
          git checkout --ours metadata/ 2>/dev/null || true
          git checkout --ours packages/ 2>/dev/null || true
          git checkout --ours .gitignore 2>/dev/null || true
          
          git add metadata/ packages/ .gitignore 2>/dev/null || true
          echo "âœ… Conflicts resolved"
        fi
        
        # å‡†å¤‡commitä¿¡æ¯
        total_packages=0
        total_size="0MB"
        if [ -d "packages" ]; then
          total_packages=$(find packages/ -name "*.tar.gz" | wc -l)
          total_size=$(du -sh packages/ | cut -f1)
        fi
        
        large_files_count=0
        if [ -d "large_files_for_release" ]; then
          large_files_count=$(ls -1 large_files_for_release/ 2>/dev/null | wc -l)
        fi
        
        commit_message="Update R packages repository
 
- Synced from ying-ge/FigureYa  
- Total packages: ${total_packages}
- Repository size: ${total_size}
- Large files (for releases): ${large_files_count}
- Updated: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
- Workflow run: ${{ github.run_number }}"
        
        # Commit
        echo "ğŸ’¾ Committing changes..."
        if git commit -m "$commit_message"; then
          echo "âœ… Commit successful"
          
          # Push with retry logic
          echo "ğŸ“¤ Pushing changes..."
          max_retries=3
          retry_count=0
          
          while [ $retry_count -lt $max_retries ]; do
            if git push origin $current_branch; then
              echo "âœ… Push successful"
              break
            else
              retry_count=$((retry_count + 1))
              echo "âš ï¸  Push attempt $retry_count failed"
              
              if [ $retry_count -lt $max_retries ]; then
                echo "ğŸ”„ Retrying in 5 seconds..."
                sleep 5
                
                # å†æ¬¡å°è¯•pull
                git pull --rebase origin $current_branch 2>/dev/null || true
              else
                echo "âŒ All push attempts failed"
                echo "ğŸ“Š Repository status:"
                git status
                echo "ğŸ“ Recent commits:"
                git log --oneline -5
                exit 1
              fi
            fi
          done
        else
          echo "âŒ Commit failed"
          echo "ğŸ“Š Repository status:"
          git status
          exit 1
        fi
