name: Backup CRAN and Bioconductor R Packages
 
on:
  workflow_dispatch:
  schedule:
    - cron: "0 3 * * 0"  # æ¯å‘¨æ—¥å‡Œæ™¨3ç‚¹
 
permissions:
  contents: write
  actions: read
 
jobs:
  backup-packages:
    runs-on: ubuntu-latest
    
    env:
      GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}
 
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
 
    - name: Set up R
      uses: r-lib/actions/setup-r@v2
      with:
        r-version: "4.3"
        use-public-rspm: true
 
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libcurl4-openssl-dev libssl-dev libxml2-dev
 
    - name: Configure Git
      run: |
        git config --global user.name "GitHub Actions Bot"
        git config --global user.email "actions@github.com"
 
    - name: Check and prepare package list
      run: |
        echo "ğŸ” æ£€æŸ¥RåŒ…åˆ—è¡¨æ–‡ä»¶..."
        
        # æ£€æŸ¥å¯èƒ½çš„æ–‡ä»¶ä½ç½®
        if [ -f ".github/docs/library_list.txt" ]; then
          echo "âœ… æ‰¾åˆ°æ–‡ä»¶: .github/docs/library_list.txt"
          cp .github/docs/library_list.txt package_list.txt
        fi
        
        # æ˜¾ç¤ºåŒ…åˆ—è¡¨ä¿¡æ¯
        echo "ğŸ“„ RåŒ…åˆ—è¡¨å†…å®¹:"
        cat package_list.txt | head -20
        echo ""
        echo "ğŸ“Š ç»Ÿè®¡: $(grep -v '^#' package_list.txt | grep -v '^$' | wc -l) ä¸ªRåŒ…"
 
    - name: Run CRAN/Bioconductor backup script
      run: |
        cat > cran_bioc_backup.R << 'EOF'
        cat("ğŸš€ å¼€å§‹CRAN/BioconductoråŒ…å¤‡ä»½è„šæœ¬...\n")
        
        # è®¾ç½®é•œåƒ
        options(repos = c(
          CRAN = "https://cloud.r-project.org/",
          BioCsoft = "https://bioconductor.org/packages/release/bioc",
          BioCann = "https://bioconductor.org/packages/release/data/annotation",
          BioCexp = "https://bioconductor.org/packages/release/data/experiment"
        ))
        
        # å°è¯•å®‰è£…BiocManagerï¼ˆå¦‚æœéœ€è¦ï¼‰
        if (!requireNamespace("BiocManager", quietly = TRUE)) {
          tryCatch({
            install.packages("BiocManager")
            cat("âœ… BiocManagerå®‰è£…æˆåŠŸ\n")
          }, error = function(e) {
            cat("âš ï¸ BiocManagerå®‰è£…å¤±è´¥ï¼Œå°†åªå¤„ç†CRANåŒ…\n")
          })
        }
        
        # è¯»å–åŒ…åˆ—è¡¨
        package_file <- "package_list.txt"
        if (!file.exists(package_file)) {
          stop("RåŒ…åˆ—è¡¨æ–‡ä»¶ä¸å­˜åœ¨")
        }
        
        lines <- readLines(package_file, warn = FALSE)
        packages <- lines[nchar(trimws(lines)) > 0 & !grepl("^#", lines)]
        packages <- trimws(packages)
        
        cat("æ‰¾åˆ°", length(packages), "ä¸ªRåŒ…\n")
        
        # åˆ›å»ºå¤‡ä»½ç›®å½•
        backup_dir <- "CRAN_Bioc_backup"
        if (!dir.exists(backup_dir)) {
          dir.create(backup_dir, recursive = TRUE)
        }
        
        # è·å–åŒ…ä¿¡æ¯çš„å‡½æ•°
        get_package_info <- function(pkg_name) {
          info <- list(
            name = pkg_name,
            source = "unknown",
            version = "unknown",
            url = NULL,
            success = FALSE
          )
          
          # é¦–å…ˆå°è¯•ä»CRANè·å–
          tryCatch({
            cran_info <- available.packages(repos = "https://cloud.r-project.org/")
            if (pkg_name %in% rownames(cran_info)) {
              info$source <- "CRAN"
              info$version <- cran_info[pkg_name, "Version"]
              info$url <- sprintf("https://cloud.r-project.org/src/contrib/%s_%s.tar.gz", 
                                 pkg_name, info$version)
              info$success <- TRUE
              return(info)
            }
          }, error = function(e) NULL)
          
          # å¦‚æœCRANæ²¡æœ‰ï¼Œå°è¯•Bioconductor
          if (requireNamespace("BiocManager", quietly = TRUE)) {
            tryCatch({
              # è·å–BioconductoråŒ…ä¿¡æ¯
              bioc_repos <- BiocManager::repositories()
              
              for (repo_name in names(bioc_repos)) {
                repo_url <- bioc_repos[repo_name]
                tryCatch({
                  bioc_info <- available.packages(repos = repo_url)
                  if (pkg_name %in% rownames(bioc_info)) {
                    info$source <- paste("Bioconductor", repo_name)
                    info$version <- bioc_info[pkg_name, "Version"]
                    
                    # æ„å»ºä¸‹è½½URL
                    if (grepl("bioc$", repo_url)) {
                      info$url <- sprintf("%s/src/contrib/%s_%s.tar.gz", 
                                         repo_url, pkg_name, info$version)
                    } else if (grepl("annotation$", repo_url)) {
                      info$url <- sprintf("%s/src/contrib/%s_%s.tar.gz", 
                                         repo_url, pkg_name, info$version)
                    } else {
                      info$url <- sprintf("%s/src/contrib/%s_%s.tar.gz", 
                                         repo_url, pkg_name, info$version)
                    }
                    
                    info$success <- TRUE
                    return(info)
                  }
                }, error = function(e) NULL)
              }
            }, error = function(e) NULL)
          }
          
          return(info)
        }
        
        # ä¸‹è½½å•ä¸ªåŒ…çš„å‡½æ•°
        download_package <- function(pkg_name, backup_dir, max_size_mb = 100) {
          cat(sprintf("ğŸ” æŸ¥æ‰¾åŒ…: %s\n", pkg_name))
          
          # åˆ›å»ºåŒ…ç›®å½•
          pkg_dir <- file.path(backup_dir, pkg_name)
          if (dir.exists(pkg_dir)) {
            unlink(pkg_dir, recursive = TRUE)
          }
          dir.create(pkg_dir)
          
          result <- list(
            package = pkg_name,
            status = "failed",
            source = "unknown",
            version = "unknown",
            file_size_mb = 0,
            date = as.character(Sys.Date())
          )
          
          # è·å–åŒ…ä¿¡æ¯
          pkg_info <- get_package_info(pkg_name)
          
          if (!pkg_info$success) {
            cat(sprintf("âŒ åŒ… %s æœªæ‰¾åˆ°\n", pkg_name))
            result$status <- "not_found"
            unlink(pkg_dir, recursive = TRUE)
            return(result)
          }
          
          cat(sprintf("ğŸ“¦ æ‰¾åˆ°åŒ…: %s v%s (%s)\n", pkg_name, pkg_info$version, pkg_info$source))
          
          result$source <- pkg_info$source
          result$version <- pkg_info$version
          
          # ä¸‹è½½åŒ…
          tryCatch({
            tar_file <- file.path(pkg_dir, sprintf("%s_%s.tar.gz", pkg_name, pkg_info$version))
            
            cat(sprintf("â¬‡ï¸ ä¸‹è½½ä¸­: %s\n", pkg_info$url))
            download.file(pkg_info$url, tar_file, mode = "wb", quiet = TRUE)
            
            if (file.exists(tar_file) && file.size(tar_file) > 100) {
              file_size_mb <- file.size(tar_file) / (1024^2)
              
              if (file_size_mb > max_size_mb) {
                cat(sprintf("âš ï¸ æ–‡ä»¶è¿‡å¤§: %.1f MBï¼Œè·³è¿‡\n", file_size_mb))
                result$status <- sprintf("skipped_large_%.1fMB", file_size_mb)
                result$file_size_mb <- file_size_mb
                file.remove(tar_file)
                unlink(pkg_dir, recursive = TRUE)
              } else {
                cat(sprintf("âœ… ä¸‹è½½æˆåŠŸ: %.1f MB\n", file_size_mb))
                result$status <- "success"
                result$file_size_mb <- round(file_size_mb, 2)
                
                # ä¿å­˜åŒ…ä¿¡æ¯
                pkg_info_file <- file.path(pkg_dir, "package_info.txt")
                info_content <- sprintf(
                  "Package: %s\nVersion: %s\nSource: %s\nURL: %s\nSize: %.2f MB\nDownload Date: %s\n",
                  pkg_name, pkg_info$version, pkg_info$source, 
                  pkg_info$url, file_size_mb, Sys.Date()
                )
                writeLines(info_content, pkg_info_file)
              }
            } else {
              cat(sprintf("âŒ ä¸‹è½½å¤±è´¥æˆ–æ–‡ä»¶æŸå\n"))
              result$status <- "download_failed"
              unlink(pkg_dir, recursive = TRUE)
            }
            
          }, error = function(e) {
            cat(sprintf("âŒ ä¸‹è½½é”™è¯¯: %s\n", e$message))
            result$status <- paste("error:", substr(e$message, 1, 50))
            unlink(pkg_dir, recursive = TRUE)
          })
          
          return(result)
        }
        
        # åˆå§‹åŒ–ç»“æœè®°å½•
        results <- data.frame(
          package = character(),
          status = character(),
          source = character(),
          version = character(),
          file_size_mb = numeric(),
          date = character(),
          stringsAsFactors = FALSE
        )
        
        # é€ä¸ªå¤„ç†åŒ…
        for (i in seq_along(packages)) {
          pkg <- packages[i]
          cat(sprintf("\n=== [%d/%d] å¤„ç†åŒ…: %s ===\n", i, length(packages), pkg))
          
          # ä¸‹è½½åŒ…
          result <- download_package(pkg, backup_dir, max_size_mb = 100)
          
          # è®°å½•ç»“æœ
          results <- rbind(results, data.frame(
            package = result$package,
            status = result$status,
            source = result$source,
            version = result$version,
            file_size_mb = result$file_size_mb,
            date = result$date,
            stringsAsFactors = FALSE
          ))
          
          # ä¿å­˜è¿›åº¦
          progress_info <- sprintf("%s|%s|%s|%s|%.2f", 
                                  result$package, result$status, result$source, 
                                  result$version, result$file_size_mb)
          writeLines(progress_info, "progress.txt")
          
          # æ¯å¤„ç†5ä¸ªåŒ…æš‚åœä¸€ä¸‹
          if (i %% 5 == 0) {
            cat("â¸ï¸ æš‚åœ2ç§’...\n")
            Sys.sleep(2)
          }
        }
        
        # ä¿å­˜æœ€ç»ˆç»“æœ
        log_file <- file.path(backup_dir, paste0("backup_log_", Sys.Date(), ".csv"))
        write.csv(results, log_file, row.names = FALSE)
        
        # ç»Ÿè®¡ç»“æœ
        success_count <- sum(results$status == "success")
        skipped_count <- sum(grepl("skipped_large", results$status))
        notfound_count <- sum(results$status == "not_found")
        failed_count <- nrow(results) - success_count - skipped_count - notfound_count
        total_size <- sum(results$file_size_mb[results$status == "success"])
        
        cran_count <- sum(results$source == "CRAN" & results$status == "success")
        bioc_count <- sum(grepl("Bioconductor", results$source) & results$status == "success")
        
        cat("\n=== æœ€ç»ˆç»Ÿè®¡ ===\n")
        cat("âœ… æˆåŠŸ:", success_count, sprintf("(CRAN: %d, Bioconductor: %d)\n", cran_count, bioc_count))
        cat("âš ï¸ è·³è¿‡(å¤§æ–‡ä»¶):", skipped_count, "\n")
        cat("â“ æœªæ‰¾åˆ°:", notfound_count, "\n")
        cat("âŒ å¤±è´¥:", failed_count, "\n")
        cat("ğŸ’¾ æ€»å¤§å°:", round(total_size, 1), "MB\n")
        
        # ä¿å­˜ç»Ÿè®¡
        summary_info <- sprintf("%d|%d|%d|%d|%.1f|%d|%d", 
                               success_count, skipped_count, notfound_count, 
                               failed_count, total_size, cran_count, bioc_count)
        writeLines(summary_info, "final_summary.txt")
        
        cat("ğŸ‰ CRAN/BioconductoråŒ…å¤‡ä»½å®Œæˆï¼\n")
        EOF
        
        # è¿è¡ŒRè„šæœ¬
        echo "ğŸš€ å¼€å§‹CRAN/BioconductoråŒ…å¤‡ä»½..."
        Rscript cran_bioc_backup.R &
        r_pid=$!
        
        # ç›‘æ§è¿›åº¦å¹¶é€ä¸€æäº¤
        echo "ğŸ”„ ç›‘æ§å¤‡ä»½è¿›åº¦..."
        last_progress=""
        commit_count=0
        
        while kill -0 $r_pid 2>/dev/null; do
          if [ -f "progress.txt" ]; then
            current_progress=$(cat progress.txt 2>/dev/null || echo "")
            
            if [ "$current_progress" != "$last_progress" ] && [ -n "$current_progress" ]; then
              package_name=$(echo "$current_progress" | cut -d'|' -f1)
              status=$(echo "$current_progress" | cut -d'|' -f2)
              source=$(echo "$current_progress" | cut -d'|' -f3)
              version=$(echo "$current_progress" | cut -d'|' -f4)
              size=$(echo "$current_progress" | cut -d'|' -f5)
              
              echo "ğŸ“¦ å¤„ç†å®Œæˆ: $package_name v$version ($source) - $status"
              
              # å¦‚æœæˆåŠŸï¼Œç«‹å³æäº¤
              if [ "$status" = "success" ]; then
                if [ -d "CRAN_Bioc_backup/$package_name" ]; then
                  echo "ğŸ’¾ æäº¤ $package_name..."
                  
                  git add "CRAN_Bioc_backup/$package_name/"
                  git add "CRAN_Bioc_backup/"*.csv 2>/dev/null || true
                  
                  if git commit -m "ğŸ“¦ Add $package_name v$version ($source, ${size}MB) - $(date +'%m-%d %H:%M')"; then
                    echo "ğŸš€ æ¨é€ä¸­..."
                    
                    # æ¨é€é‡è¯•æœºåˆ¶
                    retry=0
                    while [ $retry -lt 3 ]; do
                      if git push origin main; then
                        echo "âœ… $package_name æ¨é€æˆåŠŸ"
                        commit_count=$((commit_count + 1))
                        break
                      else
                        retry=$((retry + 1))
                        echo "âš ï¸ æ¨é€å¤±è´¥ï¼Œé‡è¯• $retry/3..."
                        sleep $((retry * 2))
                      fi
                    done
                    
                    if [ $retry -eq 3 ]; then
                      echo "âŒ $package_name æ¨é€å¤±è´¥"
                    fi
                  else
                    echo "âŒ $package_name æäº¤å¤±è´¥"
                  fi
                  
                  # æ¨é€æˆåŠŸåçŸ­æš‚æš‚åœ
                  sleep 1
                fi
              fi
              
              last_progress="$current_progress"
            fi
          fi
          
          sleep 3
        done
        
        # ç­‰å¾…Rè„šæœ¬å®Œæˆ
        wait $r_pid
        echo "ğŸ‰ Rè„šæœ¬æ‰§è¡Œå®Œæˆ"
        
        # æœ€ç»ˆæ¸…ç†å’Œæäº¤
        echo "ğŸ“Š æ‰§è¡Œæœ€ç»ˆæäº¤..."
        git add CRAN_Bioc_backup/ 2>/dev/null || true
        if ! git diff --staged --quiet; then
          git commit -m "ğŸ“Š Final CRAN/Bioconductor backup - $(date +'%Y-%m-%d')" 2>/dev/null || true
          git push origin main 2>/dev/null || true
        fi
        
        echo "âœ… æ€»è®¡æäº¤äº† $commit_count ä¸ªæˆåŠŸçš„RåŒ…"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
 
    - name: Show final summary
      if: always()
      run: |
        if [ -f "final_summary.txt" ]; then
          summary=$(cat final_summary.txt)
          success=$(echo "$summary" | cut -d'|' -f1)
          skipped=$(echo "$summary" | cut -d'|' -f2)
          notfound=$(echo "$summary" | cut -d'|' -f3)
          failed=$(echo "$summary" | cut -d'|' -f4)
          total_size=$(echo "$summary" | cut -d'|' -f5)
          cran_count=$(echo "$summary" | cut -d'|' -f6)
          bioc_count=$(echo "$summary" | cut -d'|' -f7)
          
          echo "## ğŸ“¦ CRAN/Bioconductorå¤‡ä»½ç»“æœ - $(date +'%Y-%m-%d')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| çŠ¶æ€ | æ•°é‡ | å¤‡æ³¨ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| âœ… æˆåŠŸ | $success | CRAN: $cran_count, Bioconductor: $bioc_count |" >> $GITHUB_STEP_SUMMARY
          echo "| âš ï¸ è·³è¿‡ | $skipped | æ–‡ä»¶>100MB |" >> $GITHUB_STEP_SUMMARY
          echo "| â“ æœªæ‰¾åˆ° | $notfound | åŒ…ä¸å­˜åœ¨ |" >> $GITHUB_STEP_SUMMARY
          echo "| âŒ å¤±è´¥ | $failed | ä¸‹è½½å¤±è´¥ |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ’¾ æ€»å¤§å° | ${total_size}MB | å®é™…æ¨é€æ•°æ® |" >> $GITHUB_STEP_SUMMARY
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“Š æ¥æºåˆ†å¸ƒ" >> $GITHUB_STEP_SUMMARY
          echo "- **CRANåŒ…**: $cran_count ä¸ª" >> $GITHUB_STEP_SUMMARY
          echo "- **BioconductoråŒ…**: $bioc_count ä¸ª" >> $GITHUB_STEP_SUMMARY
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ”§ å¤‡ä»½ç‰¹ç‚¹" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ“ ä¿å­˜æºç åŒ…(.tar.gz)å’ŒåŒ…ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ” è‡ªåŠ¨è¯†åˆ«CRAN/Bioconductoræ¥æº" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ“ è®°å½•ç‰ˆæœ¬å·å’Œä¸‹è½½æ—¥æœŸ" >> $GITHUB_STEP_SUMMARY
          echo "- âš¡ é€åŒ…ä¸‹è½½æ¨é€ï¼Œé¿å…ç´¯ç§¯å¤§æ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ›¡ï¸ 100MBå¤§å°é™åˆ¶ä¿æŠ¤ä»“åº“ç©ºé—´" >> $GITHUB_STEP_SUMMARY
        else
          echo "## âŒ å¤‡ä»½å¤±è´¥" >> $GITHUB_STEP_SUMMARY
          echo "æœªæ‰¾åˆ°ç»“æœæ–‡ä»¶ï¼Œè¯·æ£€æŸ¥æ—¥å¿—" >> $GITHUB_STEP_SUMMARY
        fi
        
        # æ˜¾ç¤ºå®é™…å¤‡ä»½æƒ…å†µ
        if [ -d "CRAN_Bioc_backup" ]; then
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“ å¤‡ä»½ç›®å½•çŠ¶æ€" >> $GITHUB_STEP_SUMMARY
          echo "- RåŒ…ç›®å½•æ•°: $(find CRAN_Bioc_backup -maxdepth 1 -type d | wc -l)" >> $GITHUB_STEP_SUMMARY
          echo "- æ–‡ä»¶æ€»æ•°: $(find CRAN_Bioc_backup -type f | wc -l)" >> $GITHUB_STEP_SUMMARY
          echo "- ç£ç›˜ä½¿ç”¨: $(du -sh CRAN_Bioc_backup 2>/dev/null | cut -f1 || echo 'æœªçŸ¥')" >> $GITHUB_STEP_SUMMARY
        fi
