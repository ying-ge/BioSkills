name: Backup GitHub R Packages
 
on:
  workflow_dispatch:
  schedule:
    # æ¯å‘¨å¤‡ä»½ä¸€æ¬¡ï¼Œé¿å…è¿‡äºŽé¢‘ç¹
    - cron: "0 2 * * 0"  # æ¯å‘¨æ—¥å‡Œæ™¨2ç‚¹
 
permissions:
  contents: write
  actions: read
 
jobs:
  backup-packages:
    runs-on: ubuntu-latest
    
    env:
      GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}  # ä½¿ç”¨å†…ç½®tokené¿å…APIé™åˆ¶
 
    steps:
    # æ£€å‡ºä»£ç 
    - name: Checkout repository
      uses: actions/checkout@v4  # ä½¿ç”¨æœ€æ–°ç‰ˆæœ¬
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0  # èŽ·å–å®Œæ•´åŽ†å²
 
    # è®¾ç½® R çŽ¯å¢ƒ
    - name: Set up R
      uses: r-lib/actions/setup-r@v2
      with:
        r-version: "4.3"  # ä½¿ç”¨è¾ƒæ–°çš„Rç‰ˆæœ¬
        use-public-rspm: true  # ä½¿ç”¨å…¬å…±åŒ…ç®¡ç†å™¨åŠ é€Ÿå®‰è£…
 
    # å®‰è£…å¿…è¦çš„RåŒ…
    - name: Install R dependencies
      uses: r-lib/actions/setup-r-dependencies@v2
      with:
        packages: |
          any::jsonlite
          any::httr
          any::devtools
        cache-version: 2
 
    # åˆ›å»ºå¤‡ä»½è„šæœ¬
    - name: Create backup script
      run: |
        cat > backup_repos.R << 'EOF'
        library(jsonlite)
        library(httr)
        
        # è®¾ç½®GitHub tokenï¼ˆå¦‚æžœå¯ç”¨ï¼‰
        github_token <- Sys.getenv("GITHUB_PAT")
        if (github_token != "") {
          httr::set_config(httr::add_headers(Authorization = paste("token", github_token)))
        }
        
        # è¯»å–ä»“åº“åˆ—è¡¨å‡½æ•°
        read_github_repos <- function(file_path) {
          if (!file.exists(file_path)) {
            stop("æ–‡ä»¶ä¸å­˜åœ¨: ", file_path)
          }
          
          lines <- readLines(file_path, warn = FALSE)
          lines <- lines[lines != "" & !grepl("^#", lines)]
          
          repos <- character(0)
          for (line in lines) {
            if (grepl("github.com", line)) {
              repo <- gsub(".*github.com/([^/]+/[^/]+).*", "\\1", line)
              repos <- c(repos, repo)
            } else if (grepl("^[^/]+/[^/]+$", trimws(line))) {
              repos <- c(repos, trimws(line))
            }
          }
          
          return(unique(repos))
        }
        
        # å¤‡ä»½å‡½æ•°
        backup_repos_from_file <- function(repo_file, backup_dir = "R_packages_backup") {
          cat("æ­£åœ¨ä»Žæ–‡ä»¶è¯»å–ä»“åº“åˆ—è¡¨:", repo_file, "\n")
          
          if (!file.exists(repo_file)) {
            cat("è­¦å‘Š: ä»“åº“åˆ—è¡¨æ–‡ä»¶ä¸å­˜åœ¨ï¼Œä½¿ç”¨ç¤ºä¾‹åˆ—è¡¨\n")
            github_repos <- c("tpq/kpmt", "cBioPortal/cgdsr")  # ç¤ºä¾‹
          } else {
            github_repos <- read_github_repos(repo_file)
          }
          
          cat("æ‰¾åˆ°", length(github_repos), "ä¸ªä»“åº“\n\n")
          
          if (!dir.exists(backup_dir)) {
            dir.create(backup_dir, recursive = TRUE)
          }
          
          backup_log <- data.frame(
            repo = character(),
            status = character(),
            download_date = character(),
            file_size = numeric(),
            stringsAsFactors = FALSE
          )
          
          for (i in seq_along(github_repos)) {
            repo <- github_repos[i]
            repo_name <- gsub("/", "_", repo)
            repo_dir <- file.path(backup_dir, repo_name)
            
            if (!dir.exists(repo_dir)) {
              dir.create(repo_dir)
            }
            
            cat(sprintf("[%d/%d] æ­£åœ¨å¤‡ä»½: %s\n", i, length(github_repos), repo))
            
            tryCatch({
              # å°è¯•ä¸‹è½½ä¸»åˆ†æ”¯
              zip_urls <- c(
                paste0("https://github.com/", repo, "/archive/refs/heads/master.zip"),
                paste0("https://github.com/", repo, "/archive/refs/heads/main.zip")
              )
              
              downloaded <- FALSE
              final_file <- NULL
              
              for (j in seq_along(zip_urls)) {
                branch_name <- c("master", "main")[j]
                zip_file <- file.path(repo_dir, paste0(repo_name, "_", branch_name, ".zip"))
                
                tryCatch({
                  download.file(zip_urls[j], zip_file, mode = "wb", quiet = TRUE)
                  if (file.exists(zip_file) && file.size(zip_file) > 1000) {
                    downloaded <- TRUE
                    final_file <- zip_file
                    break
                  } else if (file.exists(zip_file)) {
                    file.remove(zip_file)
                  }
                }, error = function(e) NULL)
              }
              
              if (downloaded) {
                # å°è¯•èŽ·å–ä»“åº“ä¿¡æ¯ï¼ˆæœ‰tokenæ—¶ï¼‰
                if (github_token != "") {
                  api_url <- paste0("https://api.github.com/repos/", repo)
                  tryCatch({
                    response <- httr::GET(api_url)
                    if (httr::status_code(response) == 200) {
                      repo_info <- httr::content(response, "text", encoding = "UTF-8")
                      meta_file <- file.path(repo_dir, "repository_info.json")
                      writeLines(repo_info, meta_file)
                    }
                  }, error = function(e) NULL)
                }
                
                backup_log <<- rbind(backup_log, data.frame(
                  repo = repo,
                  status = "success",
                  download_date = as.character(Sys.Date()),
                  file_size = file.size(final_file)
                ))
                
                cat("âœ“ æˆåŠŸ\n")
              } else {
                backup_log <<- rbind(backup_log, data.frame(
                  repo = repo,
                  status = "failed - no accessible branch",
                  download_date = as.character(Sys.Date()),
                  file_size = 0
                ))
                cat("âœ— å¤±è´¥\n")
              }
              
            }, error = function(e) {
              backup_log <<- rbind(backup_log, data.frame(
                repo = repo,
                status = paste("error:", e$message),
                download_date = as.character(Sys.Date()),
                file_size = 0
              ))
              cat("âœ— å‡ºé”™:", e$message, "\n")
            })
            
            # é¿å…APIé™åˆ¶
            if (i %% 10 == 0) {
              Sys.sleep(2)
            }
          }
          
          # ä¿å­˜æ—¥å¿—
          log_file <- file.path(backup_dir, paste0("backup_log_", Sys.Date(), ".csv"))
          write.csv(backup_log, log_file, row.names = FALSE)
          
          # ç”Ÿæˆç®€è¦æŠ¥å‘Š
          success_count <- sum(backup_log$status == "success")
          cat("\n=== å¤‡ä»½å®Œæˆ ===\n")
          cat("æ€»æ•°:", nrow(backup_log), "\n")
          cat("æˆåŠŸ:", success_count, "\n")
          cat("å¤±è´¥:", nrow(backup_log) - success_count, "\n")
          
          return(backup_log)
        }
        
        # æŸ¥æ‰¾ä»“åº“åˆ—è¡¨æ–‡ä»¶
        possible_paths <- c(
          ".github/docs/github_library.txt",
          "docs/github_library.txt", 
          "github_library.txt",
          "scripts/github_library.txt"
        )
        
        repo_file <- NULL
        for (path in possible_paths) {
          if (file.exists(path)) {
            repo_file <- path
            break
          }
        }
        
        if (is.null(repo_file)) {
          cat("æœªæ‰¾åˆ°ä»“åº“åˆ—è¡¨æ–‡ä»¶ï¼Œè¯·æ£€æŸ¥ä»¥ä¸‹è·¯å¾„:\n")
          cat(paste(possible_paths, collapse = "\n"))
          quit(status = 1)
        }
        
        # æ‰§è¡Œå¤‡ä»½
        backup_log <- backup_repos_from_file(repo_file)
        EOF
 
    # è¿è¡Œå¤‡ä»½è„šæœ¬
    - name: Run backup script
      run: Rscript backup_repos.R
 
    # æ£€æŸ¥å¤‡ä»½ç»“æžœå¤§å°
    - name: Check backup size
      run: |
        if [ -d "R_packages_backup" ]; then
          echo "å¤‡ä»½ç›®å½•å¤§å°:"
          du -sh R_packages_backup/
          echo "æ–‡ä»¶æ•°é‡:"
          find R_packages_backup -type f | wc -l
        else
          echo "å¤‡ä»½ç›®å½•ä¸å­˜åœ¨"
          exit 1
        fi
 
    # é…ç½®Gitï¼ˆä»…åœ¨æœ‰æ–‡ä»¶å˜æ›´æ—¶ï¼‰
    - name: Configure Git
      run: |
        git config --global user.name "GitHub Actions Bot"
        git config --global user.email "actions@github.com"
 
    # æäº¤å¤‡ä»½æ–‡ä»¶
    - name: Commit and push backup
      run: |
        git add R_packages_backup/
        if git diff --staged --quiet; then
          echo "æ²¡æœ‰æ–°çš„å¤‡ä»½æ–‡ä»¶éœ€è¦æäº¤"
        else
          git commit -m "ðŸ“¦ Update R packages backup - $(date +'%Y-%m-%d')"
          git push
        fi
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
 
    # åˆ›å»ºå¤‡ä»½æ‘˜è¦
    - name: Create backup summary
      if: always()
      run: |
        if [ -f "R_packages_backup/backup_log_$(date +'%Y-%m-%d').csv" ]; then
          echo "## ðŸ“Š å¤‡ä»½æ‘˜è¦ - $(date +'%Y-%m-%d')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| çŠ¶æ€ | æ•°é‡ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|" >> $GITHUB_STEP_SUMMARY
          
          # ç»Ÿè®¡æˆåŠŸå¤±è´¥æ•°é‡
          success_count=$(grep -c "success" "R_packages_backup/backup_log_$(date +'%Y-%m-%d').csv" || echo "0")
          total_count=$(tail -n +2 "R_packages_backup/backup_log_$(date +'%Y-%m-%d').csv" | wc -l || echo "0")
          failed_count=$((total_count - success_count))
          
          echo "| âœ… æˆåŠŸ | $success_count |" >> $GITHUB_STEP_SUMMARY
          echo "| âŒ å¤±è´¥ | $failed_count |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“¦ æ€»è®¡ | $total_count |" >> $GITHUB_STEP_SUMMARY
          
          if [ -d "R_packages_backup" ]; then
            backup_size=$(du -sh R_packages_backup/ | cut -f1)
            echo "| ðŸ’¾ å¤§å° | $backup_size |" >> $GITHUB_STEP_SUMMARY
          fi
        fi
