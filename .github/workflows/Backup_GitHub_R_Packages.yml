name: Backup GitHub R Packages (Fixed Dependencies)
 
on:
  workflow_dispatch:
  schedule:
    - cron: "0 2 * * 0"
 
permissions:
  contents: write
  actions: read
 
jobs:
  backup-packages:
    runs-on: ubuntu-latest
    
    env:
      GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}
 
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
 
    - name: Set up R
      uses: r-lib/actions/setup-r@v2
      with:
        r-version: "4.3"
        use-public-rspm: true
 
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libcurl4-openssl-dev libssl-dev libxml2-dev
 
    - name: Install R dependencies
      run: |
        Rscript -e "
        options(repos = c(CRAN = 'https://cloud.r-project.org/'))
        install.packages(c('jsonlite', 'httr', 'curl'), dependencies = TRUE)
        "
 
    - name: Verify R packages
      run: |
        Rscript -e "
        cat('æ£€æŸ¥åŒ…å®‰è£…çŠ¶æ€:\n')
        packages <- c('jsonlite', 'httr', 'curl')
        for (pkg in packages) {
          if (require(pkg, character.only = TRUE, quietly = TRUE)) {
            cat('âœ…', pkg, 'OK\n')
          } else {
            cat('âŒ', pkg, 'FAILED\n')
          }
        }
        "
 
    - name: Configure Git
      run: |
        git config --global user.name "GitHub Actions Bot"
        git config --global user.email "actions@github.com"
 
    - name: Prepare repository list
      run: |
        echo "ğŸ” å‡†å¤‡ä»“åº“åˆ—è¡¨..."
        
        # åˆ›å»ºä»“åº“åˆ—è¡¨æ–‡ä»¶
        cat > repo_list.txt << 'EOF'
        tpq/kpmt
        cBioPortal/cgdsr
        satijalab/seurat-data
        jespermaag/gganatogram
        chrisamiller/fishplot
        BITS-VIB/venn-tools
        FredHutch/Galeano-Nino-Bullman-Intratumoral-Microbiota_2022
        Gibbsdavidl/Immune-Subtype-Clustering
        Gibbsdavidl/ImmuneSubtypeClassifier
        GuangchuangYu/gglayer
        IOBR/IOBR
        IndrajeetPatil/ggstatsplot
        KrishnaswamyLab/MAGIC
        NKI-CCB/DISCOVER
        Simon-Coetzee/motifBreakR
        Teichlab/cellphonedb
        YuLab-SMU/clusterProfiler-book
        aertslab/pySCENIC
        califano-lab/ARACNe-AP
        cole-trapnell-lab/monocle-release
        cran/colorfulVennPlot
        dylkot/cNMF
        ebecht/MCPcounter
        fawda123/ggord
        icbi-lab/Immunophenogram
        inutano/pfastq-dump
        johncolby/SVM-RFE
        linnarsson-lab/ipynb-lamanno2016
        lmcinnes/umap
        matanhofree/crc-immune-hubs
        matt-black/dcapy
        mg14/mg14
        nicholasehamilton/ggtern
        paulgeeleher/pRRophetic
        paulgeeleher/pRRophetic2
        peterawe/CMScaller
        raerose01/deconstructSigs
        rfordatascience/tidytuesday
        richie2019/MBpanel
        ropensci/rentrez
        rsankowski/sankowski-et-al-microglia
        spren9er/tidytuesday
        taoliu/MACS
        wanyewang1/Index_model
        woobe/rPlotter
        xlucpu/MOVICS
        zzwch/crosslink
        fbertran/plsRcox
        binderh/CoxBoost
        EOF
        
        echo "âœ… åˆ›å»ºäº†åŒ…å« $(wc -l < repo_list.txt) ä¸ªä»“åº“çš„åˆ—è¡¨"
 
    - name: Run backup script
      run: |
        # åˆ›å»ºä¸ä¾èµ–httrçš„ç®€åŒ–ç‰ˆæœ¬
        cat > minimal_backup.R << 'EOF'
        # åªä½¿ç”¨åŸºç¡€RåŠŸèƒ½å’Œjsonlite
        cat("å¼€å§‹å¤‡ä»½è„šæœ¬...\n")
        
        # å°è¯•åŠ è½½jsonliteï¼Œå¦‚æœå¤±è´¥å°±ç”¨åŸºç¡€R
        use_jsonlite <- TRUE
        tryCatch({
          library(jsonlite)
          cat("âœ… jsonliteåŠ è½½æˆåŠŸ\n")
        }, error = function(e) {
          cat("âš ï¸ jsonliteåŠ è½½å¤±è´¥ï¼Œä½¿ç”¨åŸºç¡€R\n")
          use_jsonlite <<- FALSE
        })
        
        # è®¾ç½®GitHub tokenï¼ˆç”¨äºä¸‹è½½ï¼Œä¸æ˜¯APIï¼‰
        github_token <- Sys.getenv("GITHUB_PAT")
        
        # è¯»å–ä»“åº“åˆ—è¡¨
        repo_file <- "repo_list.txt"
        if (!file.exists(repo_file)) {
          stop("ä»“åº“åˆ—è¡¨æ–‡ä»¶ä¸å­˜åœ¨")
        }
        
        lines <- readLines(repo_file, warn = FALSE)
        repos <- lines[nchar(trimws(lines)) > 0 & !grepl("^#", lines)]
        repos <- trimws(repos)
        
        cat("æ‰¾åˆ°", length(repos), "ä¸ªä»“åº“\n")
        
        # åˆ›å»ºå¤‡ä»½ç›®å½•
        backup_dir <- "R_packages_backup"
        if (!dir.exists(backup_dir)) {
          dir.create(backup_dir, recursive = TRUE)
        }
        
        # åˆå§‹åŒ–ç»“æœè®°å½•
        results <- data.frame(
          repo = character(),
          status = character(),
          file_size_mb = numeric(),
          date = character(),
          stringsAsFactors = FALSE
        )
        
        # ç®€å•çš„APIè°ƒç”¨å‡½æ•°ï¼ˆä¸ä½¿ç”¨httrï¼‰
        get_repo_info <- function(repo) {
          if (nchar(github_token) == 0) return(NULL)
          
          api_url <- sprintf("https://api.github.com/repos/%s", repo)
          temp_file <- tempfile()
          
          tryCatch({
            # ä½¿ç”¨curlå‘½ä»¤è¡Œå·¥å…·
            system_cmd <- sprintf('curl -s -H "Authorization: token %s" "%s" -o "%s"', 
                                 github_token, api_url, temp_file)
            result <- system(system_cmd, intern = FALSE)
            
            if (result == 0 && file.exists(temp_file) && file.size(temp_file) > 10) {
              content <- readLines(temp_file, warn = FALSE)
              return(paste(content, collapse = "\n"))
            }
          }, error = function(e) NULL)
          
          return(NULL)
        }
        
        # é€ä¸ªå¤„ç†ä»“åº“
        for (i in seq_along(repos)) {
          repo <- repos[i]
          cat(sprintf("\n[%d/%d] å¤„ç†: %s\n", i, length(repos), repo))
          
          # åˆ›å»ºä»“åº“ç›®å½•
          repo_name <- gsub("/", "_", repo)
          repo_dir <- file.path(backup_dir, repo_name)
          
          if (dir.exists(repo_dir)) {
            unlink(repo_dir, recursive = TRUE)
          }
          dir.create(repo_dir)
          
          # åˆå§‹åŒ–ç»“æœ
          result <- data.frame(
            repo = repo,
            status = "failed",
            file_size_mb = 0,
            date = as.character(Sys.Date()),
            stringsAsFactors = FALSE
          )
          
          # å°è¯•ä¸‹è½½
          tryCatch({
            # å°è¯•masterå’Œmainåˆ†æ”¯
            branches <- c("master", "main")
            downloaded <- FALSE
            
            for (branch in branches) {
              zip_url <- sprintf("https://github.com/%s/archive/refs/heads/%s.zip", repo, branch)
              zip_file <- file.path(repo_dir, sprintf("%s_%s.zip", repo_name, branch))
              
              cat(sprintf("å°è¯•ä¸‹è½½ %s åˆ†æ”¯...\n", branch))
              
              tryCatch({
                download.file(zip_url, zip_file, mode = "wb", quiet = TRUE, method = "auto")
                
                if (file.exists(zip_file) && file.size(zip_file) > 1000) {
                  file_size_mb <- file.size(zip_file) / (1024^2)
                  
                  # æ£€æŸ¥æ–‡ä»¶å¤§å°
                  if (file_size_mb > 100) {
                    cat(sprintf("âš ï¸ æ–‡ä»¶è¿‡å¤§: %.1f MBï¼Œè·³è¿‡\n", file_size_mb))
                    result$status <- sprintf("skipped_large_%.1fMB", file_size_mb)
                    result$file_size_mb <- file_size_mb
                    file.remove(zip_file)
                  } else {
                    cat(sprintf("âœ… ä¸‹è½½æˆåŠŸ: %.1f MB\n", file_size_mb))
                    result$status <- "success"
                    result$file_size_mb <- round(file_size_mb, 2)
                    downloaded <- TRUE
                    
                    # å°è¯•è·å–ä»“åº“ä¿¡æ¯
                    repo_info <- get_repo_info(repo)
                    if (!is.null(repo_info)) {
                      info_file <- file.path(repo_dir, "repo_info.json")
                      writeLines(repo_info, info_file)
                      cat("ğŸ“„ ä»“åº“ä¿¡æ¯å·²ä¿å­˜\n")
                    }
                  }
                  break
                } else {
                  cat(sprintf("âŒ %s åˆ†æ”¯ä¸‹è½½å¤±è´¥æˆ–æ–‡ä»¶å¤ªå°\n", branch))
                  if (file.exists(zip_file)) {
                    file.remove(zip_file)
                  }
                }
              }, error = function(e) {
                cat(sprintf("âŒ %s åˆ†æ”¯ä¸‹è½½é”™è¯¯: %s\n", branch, e$message))
                if (file.exists(zip_file)) {
                  file.remove(zip_file)
                }
              })
            }
            
            if (!downloaded) {
              cat("âŒ æ‰€æœ‰åˆ†æ”¯éƒ½ä¸‹è½½å¤±è´¥\n")
              result$status <- "failed_no_branch"
              unlink(repo_dir, recursive = TRUE)
            }
            
          }, error = function(e) {
            cat("âŒ å¤„ç†é”™è¯¯:", e$message, "\n")
            result$status <- paste("error:", substr(e$message, 1, 50))
            unlink(repo_dir, recursive = TRUE)
          })
          
          # è®°å½•ç»“æœ
          results <- rbind(results, result)
          
          # ä¿å­˜è¿›åº¦ï¼ˆç”¨äºå¤–éƒ¨ç›‘æ§ï¼‰
          progress_info <- sprintf("%s|%s|%.2f", repo, result$status, result$file_size_mb)
          writeLines(progress_info, "progress.txt")
          
          # æ¯5ä¸ªä»“åº“æš‚åœä¸€ä¸‹ï¼Œé¿å…è¢«é™åˆ¶
          if (i %% 5 == 0) {
            cat("â¸ï¸ æš‚åœ2ç§’...\n")
            Sys.sleep(2)
          }
        }
        
        # ä¿å­˜æœ€ç»ˆç»“æœ
        log_file <- file.path(backup_dir, paste0("backup_log_", Sys.Date(), ".csv"))
        write.csv(results, log_file, row.names = FALSE)
        
        # ç»Ÿè®¡ç»“æœ
        success_count <- sum(results$status == "success")
        skipped_count <- sum(grepl("skipped_large", results$status))
        failed_count <- nrow(results) - success_count - skipped_count
        total_size <- sum(results$file_size_mb[results$status == "success"])
        
        cat("\n=== æœ€ç»ˆç»Ÿè®¡ ===\n")
        cat("âœ… æˆåŠŸ:", success_count, "\n")
        cat("âš ï¸ è·³è¿‡(å¤§æ–‡ä»¶):", skipped_count, "\n")
        cat("âŒ å¤±è´¥:", failed_count, "\n")
        cat("ğŸ’¾ æ€»å¤§å°:", round(total_size, 1), "MB\n")
        
        # ä¿å­˜ç»Ÿè®¡
        summary_info <- sprintf("%d|%d|%d|%.1f", success_count, skipped_count, failed_count, total_size)
        writeLines(summary_info, "final_summary.txt")
        
        cat("ğŸ‰ å¤‡ä»½è„šæœ¬å®Œæˆï¼\n")
        EOF
        
        # è¿è¡ŒRè„šæœ¬
        echo "ğŸš€ å¼€å§‹å¤‡ä»½..."
        Rscript minimal_backup.R &
        r_pid=$!
        
        # ç›‘æ§è¿›åº¦å¹¶é€ä¸€æäº¤
        echo "ğŸ”„ ç›‘æ§å¤‡ä»½è¿›åº¦..."
        last_progress=""
        commit_count=0
        
        while kill -0 $r_pid 2>/dev/null; do
          if [ -f "progress.txt" ]; then
            current_progress=$(cat progress.txt 2>/dev/null || echo "")
            
            if [ "$current_progress" != "$last_progress" ] && [ -n "$current_progress" ]; then
              repo_name=$(echo "$current_progress" | cut -d'|' -f1)
              status=$(echo "$current_progress" | cut -d'|' -f2)
              size=$(echo "$current_progress" | cut -d'|' -f3)
              
              echo "ğŸ“¦ å¤„ç†å®Œæˆ: $repo_name ($status)"
              
              # å¦‚æœæˆåŠŸï¼Œç«‹å³æäº¤
              if [ "$status" = "success" ]; then
                repo_dir_name=$(echo "$repo_name" | sed 's/\//_/g')
                if [ -d "R_packages_backup/$repo_dir_name" ]; then
                  echo "ğŸ’¾ æäº¤ $repo_name..."
                  
                  git add "R_packages_backup/$repo_dir_name/"
                  git add "R_packages_backup/"*.csv 2>/dev/null || true
                  
                  if git commit -m "ğŸ“¦ Add $repo_name (${size}MB) - $(date +'%m-%d %H:%M')"; then
                    echo "ğŸš€ æ¨é€ä¸­..."
                    
                    # æ¨é€é‡è¯•æœºåˆ¶
                    retry=0
                    while [ $retry -lt 3 ]; do
                      if git push origin main; then
                        echo "âœ… $repo_name æ¨é€æˆåŠŸ"
                        commit_count=$((commit_count + 1))
                        break
                      else
                        retry=$((retry + 1))
                        echo "âš ï¸ æ¨é€å¤±è´¥ï¼Œé‡è¯• $retry/3..."
                        sleep $((retry * 2))
                      fi
                    done
                    
                    if [ $retry -eq 3 ]; then
                      echo "âŒ $repo_name æ¨é€å¤±è´¥"
                    fi
                  else
                    echo "âŒ $repo_name æäº¤å¤±è´¥"
                  fi
                  
                  # æ¨é€æˆåŠŸåçŸ­æš‚æš‚åœ
                  sleep 1
                fi
              fi
              
              last_progress="$current_progress"
            fi
          fi
          
          sleep 3
        done
        
        # ç­‰å¾…Rè„šæœ¬å®Œæˆ
        wait $r_pid
        echo "ğŸ‰ Rè„šæœ¬æ‰§è¡Œå®Œæˆ"
        
        # æœ€ç»ˆæ¸…ç†å’Œæäº¤
        echo "ğŸ“Š æ‰§è¡Œæœ€ç»ˆæäº¤..."
        git add R_packages_backup/ 2>/dev/null || true
        if ! git diff --staged --quiet; then
          git commit -m "ğŸ“Š Final backup cleanup - $(date +'%Y-%m-%d')" 2>/dev/null || true
          git push origin main 2>/dev/null || true
        fi
        
        echo "âœ… æ€»è®¡æäº¤äº† $commit_count ä¸ªæˆåŠŸçš„ä»“åº“"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
 
    - name: Show final summary
      if: always()
      run: |
        if [ -f "final_summary.txt" ]; then
          summary=$(cat final_summary.txt)
          success=$(echo "$summary" | cut -d'|' -f1)
          skipped=$(echo "$summary" | cut -d'|' -f2)
          failed=$(echo "$summary" | cut -d'|' -f3)
          total_size=$(echo "$summary" | cut -d'|' -f4)
          
          echo "## ğŸ“Š å¤‡ä»½ç»“æœ - $(date +'%Y-%m-%d')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| çŠ¶æ€ | æ•°é‡ | å¤‡æ³¨ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| âœ… æˆåŠŸ | $success | å·²ä¸‹è½½å¹¶æ¨é€ |" >> $GITHUB_STEP_SUMMARY
          echo "| âš ï¸ è·³è¿‡ | $skipped | æ–‡ä»¶>100MB |" >> $GITHUB_STEP_SUMMARY
          echo "| âŒ å¤±è´¥ | $failed | ä¸‹è½½å¤±è´¥ |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ’¾ æ€»å¤§å° | ${total_size}MB | å®é™…æ¨é€æ•°æ® |" >> $GITHUB_STEP_SUMMARY
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ”§ æŠ€æœ¯ç»†èŠ‚" >> $GITHUB_STEP_SUMMARY
          echo "- ä½¿ç”¨åŸºç¡€R + curlï¼Œé¿å…å¤æ‚ä¾èµ–" >> $GITHUB_STEP_SUMMARY
          echo "- é€ä¸€ä¸‹è½½æ¨é€ï¼Œé¿å…å¤§æ–‡ä»¶ç´¯ç§¯" >> $GITHUB_STEP_SUMMARY
          echo "- è‡ªåŠ¨é‡è¯•æ¨é€å¤±è´¥çš„æƒ…å†µ" >> $GITHUB_STEP_SUMMARY
          echo "- 100MBå¤§å°é™åˆ¶ï¼Œä¿æŠ¤ä»“åº“ç©ºé—´" >> $GITHUB_STEP_SUMMARY
        else
          echo "## âŒ å¤‡ä»½å¤±è´¥" >> $GITHUB_STEP_SUMMARY
          echo "æœªæ‰¾åˆ°ç»“æœæ–‡ä»¶ï¼Œè¯·æ£€æŸ¥æ—¥å¿—" >> $GITHUB_STEP_SUMMARY
        fi
        
        # æ˜¾ç¤ºå®é™…å¤‡ä»½æƒ…å†µ
        if [ -d "R_packages_backup" ]; then
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“ å¤‡ä»½ç›®å½•çŠ¶æ€" >> $GITHUB_STEP_SUMMARY
          echo "- ä»“åº“ç›®å½•æ•°: $(find R_packages_backup -maxdepth 1 -type d | wc -l)" >> $GITHUB_STEP_SUMMARY
          echo "- æ–‡ä»¶æ€»æ•°: $(find R_packages_backup -type f | wc -l)" >> $GITHUB_STEP_SUMMARY
          echo "- ç£ç›˜ä½¿ç”¨: $(du -sh R_packages_backup 2>/dev/null | cut -f1 || echo 'æœªçŸ¥')" >> $GITHUB_STEP_SUMMARY
        fi
