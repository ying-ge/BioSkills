name: Download and Push R Packages

on:
  workflow_dispatch:
  
permissions:
  contents: write 
  
jobs:
  download-and-push:
    runs-on: ubuntu-latest

    steps:
    # 检出代码
    - name: Checkout repository
      uses: actions/checkout@v3

    # 设置 R 环境
    - name: Set up R
      uses: r-lib/actions/setup-r@v2
      with:
        r-version: "latest" 

    # 安装R脚本依赖的系统工具
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libcurl4-openssl-dev libxml2-dev libssl-dev

    # 安装R脚本所需的包
    - name: Install R packages
      run: |
        Rscript -e "install.packages(c('devtools', 'remotes', 'packrat', 'miniCRAN'), repos='https://cloud.r-project.org/')"

    # 运行R脚本
    - name: Run the R script
      run: |
        Rscript .github/scripts/download_from_github.R

    # 配置git
    - name: Configure Git
      run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"

    # 提交下载的文件
    - name: Push downloaded packages
      run: |
        git add r_packages_with_deps
        git commit -m "Add downloaded R packages"
        git push
